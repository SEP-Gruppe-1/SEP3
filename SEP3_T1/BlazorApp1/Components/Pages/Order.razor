@page "/order/{screeningId:int}/"
@using System.Security.Claims
@using BlazorApp1.Components.Layout
@using Entities
@using Microsoft.AspNetCore.Authorization
@inject AuthenticationStateProvider AuthenticationStateProvider
@using Microsoft.AspNetCore.Components.Authorization
@inject BlazorApp1.Services.TokenAuthenticationStateProvider TokenProvider
@inject IJSRuntime Js
@using RepositoryContracts
@inject IScreeningRepository ScreeningRepo
@inject NavigationManager Nav
@layout AuthorizedLayout

@if (isLoading)
{
    <p><strong>Loading...</strong></p>
}
else if (screening == null)
{
    <p><strong>Filmvisning ikke fundet</strong></p>
}
else
{
    <!--  Film Poster og info  -->
    <div class="order-header">
        <div class="container py-4">
            <div class="order-header-inner">
                <!-- Poster -->
                <img src="@GetPoster(screening.movie)" alt="@screening.movie.MovieTitle"
                     class="img-fluid rounded shadow-sm order-poster"/>
                <!-- Info -->
                <div>
                    <h2 class="mb-3">@screening.movie.MovieTitle</h2>

                    <p class="mb-1">
                        <strong>
                            @screening.date.ToString("d. MMMM yyyy") kl. @screening.startTime.ToString("HH':'mm")
                        </strong>
                    </p>

                    <p class="mb-1">
                        <strong>Sal: @screening.hallId</strong>
                    </p>

                    <p class="mb-1">
                        <strong>
                            Genre: @screening.movie.Genre
                        </strong>
                    </p>

                    <p class="mb-1">
                        Varighed: @screening.movie.DurationMinutes min
                    </p>
                </div>
            </div>
        </div>
    </div>
    <!-- Legend -->
    <div class="legend">
        <div class="legend-item">
            <span class="legend-color available"></span> Ledig
        </div>
        <div class="legend-item">
            <span class="legend-color selected"></span> Valgt
        </div>
        <div class="legend-item">
            <span class="legend-color booked"></span> Optaget
        </div>
    </div>

    <!-- Sal/sæder -->
    <div class="hall-container">
        <div class="screen">Lærred</div>

        <div class="hall">
            @foreach (var rowGroup in seat
                          .GroupBy(s => s.Number)
                          .OrderBy(g => g.Key))
            {
                <div class="seat-row">
                    @foreach (var s in rowGroup.OrderBy(s => s.Row))
                    {
                        <button class="@GetSeatCss(s)" disabled="@s.IsBooked"
                                @onclick="() => ToggleSeat(s)">@s.Row @s.Number</button>
                        //<button class="seat">@s.Row @s.Number</button>
                    }
                </div>
            }
        </div>
        
        <!-- vælg sæder -->
        @if (selectedSeats.Any())
        {
            <div class="selected-info">
                <strong>Valgt sæder: </strong>
                @string.Join(", ", selectedSeats.Select(s => $"{s.Row}{s.Number}"))
            </div>
        }

    </div>
    
    <!--Info om valgte sæder + pris -->
    
    <div class="selection-info">
        <p>
            @if (!selectedSeats.Any())
            {
                <span>Ingen sæder valgt</span>
            }
            else
            {
                <span>@string.Join(", ", selectedSeats.Select(s =>$"{s.Row}{s.Number}"))</span>
            }
        </p>
        <p>
            <strong>Pris: </strong>
            @TotalPrice.ToString("0.00") DKK
        </p>
        <button class="btn btn-success"
                disabled="@(!selectedSeats.Any())"
                @onclick="ConfirmSelection">
            Bekræft valg
        </button>
    </div>

    @code
    {
        [Parameter] public int screeningId { get; set; }

        private bool isLoading = true;
        private Screening? screening;

        private List<Seat> seat;
        private readonly List<Seat> selectedSeats = new();

        private readonly List<Seat> myBookedSeats = new();
        
        private HashSet<int> selectedSeatIds = new();
        private const decimal TicketPrice = 110m;
        
        private string? errorMessage;
        private string? successMessage;
        
        private decimal TotalPrice => selectedSeats.Count * TicketPrice;

        protected override async Task OnInitializedAsync()
        {
            isLoading = true;
            try
            {
                screening = await ScreeningRepo.getSingleAsync(screeningId);
                seat = screening.hall.Seats;
                mySeats();
            }
            finally
            {
                isLoading = false;
            }
        }

        private void ToggleSeat(Seat s)
        {
            if (s.IsBooked) return;

            if (selectedSeats.Contains(s))
                selectedSeats.Remove(s);
            else
                selectedSeats.Add(s);
        }

        private string GetSeatCss(Seat s)
        {
            var classes = new List<string> { "seat" };
            if (myBookedSeats.Any(x => x.id == s.id))
            {
                classes.Add("mybooked");
                return string.Join(" ", classes);
            }
            if (s.IsBooked)
            {
                classes.Add("booked");
            }
            else
            {
                classes.Add("available");
                if (selectedSeats.Contains(s))
                    classes.Add("selected");
            }

            return string.Join(" ", classes);
        }

        private string GetPoster(Movie movie)
        {
            var fileName = movie.MovieTitle
                .ToLower()
                .Replace(" ", "-") + ".png";

            return $"images/posters/{fileName}";
        }

        private async Task ConfirmSelection()
        {
            if (!selectedSeats.Any())
            {
                errorMessage = "Ingen sæder valgt.";
                return;
            }

            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;
            var phone = user.FindFirst("Phone")?.Value;
            if (phone == null)
            {
                errorMessage = "Du skal være logget ind for at booke sæder.";
                return;
            }

            try
            {
                var seatIdsToBook = selectedSeats.Select(s => s.id).ToList();
                
                await ScreeningRepo.BookSeatsAsync(screeningId, seatIdsToBook, phone);

                foreach (var s in selectedSeats)
                {
                    s.IsBooked = true;
                }

                selectedSeats.Clear();

                successMessage = "Sæderne er blevet booket succesfuldt.";
            }
            catch (Exception ex)
            {
                errorMessage = $"Fejl ved booking af sæder: {ex.Message}";
            }
        }

        private async void mySeats()
        {
            var authState = await AuthenticationStateProvider.GetAuthenticationStateAsync();
            var user = authState.User;

            // Hent phone-claim
            var phone = user.FindFirst("phone")?.Value;
            foreach (var seat in seat)
            {
                if (seat.IsBooked)
                {
                    if (seat.Customer.Phone == phone)
                    {
                        myBookedSeats.Add(seat);
                    }
                    
                }
            }
            
            {
            }
        }

        private async Task Logout()
        {
            await Js.InvokeVoidAsync("localStorage.removeItem", "jwt");
            await TokenProvider.SignOut();
            Nav.NavigateTo("/login", true);
        }
    }
}