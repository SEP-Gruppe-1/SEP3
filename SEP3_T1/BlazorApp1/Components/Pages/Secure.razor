@page "/secure"
@using BlazorApp1.Services
@using Microsoft.AspNetCore.Components.Authorization
@inject TokenAuthenticationStateProvider TokenProvider
@inject IJSRuntime Js
@inject NavigationManager Nav

<AuthorizeView>
    <Authorized>
        <h3>Welcome!</h3>
        <p>You have access to the secure area.</p>
        <button class="btn btn-outline-secondary" @onclick="SignOut">Sign out</button>
    </Authorized>

    <NotAuthorized>
        <h3>You are not logged in</h3>
        <p>Please log in to access this page.</p>
        <a class="btn btn-primary" href="/login">Go to login</a>
    </NotAuthorized>
</AuthorizeView>

@code {
    private bool _loadedOnce = false;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !_loadedOnce)
        {
            _loadedOnce = true;
            await TokenProvider.LoadJwtFromStorage(Js);

            // Efter login-state er loaded → UI skal re-renderes
            StateHasChanged();
        }
    }

    private async Task SignOut()
    {
        await Js.InvokeVoidAsync("localStorage.removeItem", "jwt");
        await TokenProvider.SignOut();
        Nav.NavigateTo("/login", true);
    }
}