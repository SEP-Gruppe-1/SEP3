@page "/SignUp"
@using System.ComponentModel.DataAnnotations
@using ApiContract
@using BlazorApp1.Services
@rendermode InteractiveServer
@inject NavigationManager Nav
@inject ICustomerService CustomerService
<PageTitle>Sign up</PageTitle>

<div class="card mb-4">
    <div class="card-header">Sign up</div>
    <div class="card-body">
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">@errorMessage</div>
        }
        <EditForm Model="newCustomer" OnValidSubmit="SaveCustomerAsync" FormName="SignUpForm">
            <DataAnnotationsValidator/>

            <div class="mb-3">
                <label class="form-label">Name:</label>
                <InputText @bind-Value="newCustomer.Name" class="form-control"/>
                <ValidationMessage For="() => newCustomer.Name"/>
            </div>

            <div class="mb-3">
                <label class="form-label">Phone number:</label>
                <InputText @bind-Value="newCustomer.Phone" class="form-control"/>
                <ValidationMessage For="() => newCustomer.Phone"/>
            </div>

            <div class="mb-3">
                <label class="form-label">Email:</label>
                <InputText @bind-Value="newCustomer.Email" class="form-control"/>
                <ValidationMessage For="() => newCustomer.Email"/>
            </div>

            <div class="mb-3">
                <label class="form-label">Password:</label>
                <InputText @bind-Value="newCustomer.Password" type="password" class="form-control"/>
                <ValidationMessage For="() => newCustomer.Password"/>
            </div>

            <button class="btn btn-success" type="submit" disabled="@isBusy" FormName="SignUpForm">Sign Up</button>

        </EditForm>
    </div>
</div>

@code
{
    private CreateCustomerFromModel newCustomer = new();
    private bool isBusy;
    private string? errorMessage;

    private class CreateCustomerFromModel
    {
        [Required(ErrorMessage = "Phone number is required")]
        [MinLength(8)]
        [MaxLength(8)]
        public string Phone { get; set; }

        [Required(ErrorMessage = "Name is required")]
        [MinLength(2)]
        [MaxLength(100)]
        public string? Name { get; set; }

        [Required(ErrorMessage = "Email is required")]
        [EmailAddress]
        public string? Email { get; set; }

        [Required(ErrorMessage = "Password is required")]
        [MinLength(8)]
        [MaxLength(100)]
        public string? Password { get; set; }
    }

    private async Task SaveCustomerAsync()
    {
        // to ensure phone is numeric
        isBusy = true;
        try
        {
            var customerDto = new SaveCustomerDto
            (
                Phone: int.Parse(newCustomer.Phone!),
                Name: newCustomer.Name!,
                Email: newCustomer.Email!,
                Password: newCustomer.Password!
            );

            await CustomerService.SaveCustomerAsync(customerDto);

            Nav.NavigateTo("/customer");

        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }

}
