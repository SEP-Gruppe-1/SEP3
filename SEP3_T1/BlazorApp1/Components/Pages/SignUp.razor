@page "/SignUp"
@using System.ComponentModel.DataAnnotations
@using ApiContract
@using BlazorApp1.Services
@using Grpccinema
@using RepositoryContracts 
@inject ICustomerService CustomerService
<PageTitle>Sign up</PageTitle>

<div class="card mb-4">
    <div class="card-header">Sign up</div>
    <div class="card-body">
        <EditForm Model="newCustomer" OnValidSubmit="SaveCustomerAsync">
            <DataAnnotationsValidator/>
            <ValidationSummary/>

            <div class="mb-3">
                <label class="form-label">Phone number:</label>
                <InputText @bind-Value="newCustomer.Phone" class="form-control"/>
                <ValidationMessage For="() => newCustomer.Phone"/>
            </div>
            
            <button class="btn btn-success" disabled="@isBusy">Create</button>
        </EditForm>
    </div>
</div>

@code
{
    private CreateCustomerFromModel newCustomer = new();
    private bool isBusy;

    private class CreateCustomerFromModel
    {
        [Required (ErrorMessage = "Phone number is required")] [MinLength(8)] [MaxLength(8)]
        public string Phone { get; set; }
        
        [Required (ErrorMessage = "Name is required")] [MinLength(2)] [MaxLength(50)]
        public string? Name { get; set; }
        
        [Required (ErrorMessage = "Email is required")] [EmailAddress]
        public string? Email { get; set; }
        
        [Required (ErrorMessage = "Password is required")] [MinLength(8)] [MaxLength(50)]
        public string? Password { get; set; }
    }
    
    private async Task SaveCustomerAsync()
    {
         // to ensure phone is numeric
        isBusy = true;
        try
        {
            SaveCustomerDto customerDto = new SaveCustomerDto 
            (
                Phone: int.Parse( newCustomer.Phone),
                Name: newCustomer.Name!,
                Email: newCustomer.Email!,
                Password: newCustomer.Password!
            );

            await CustomerService.SaveCustomerAsync(customerDto);
        }
        finally
        {
            isBusy = false;
        }
    }
    
}
