@page "/customer"
@using ApiContract
@using BlazorApp1.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject AuthenticationStateProvider Auth
@inject ICustomerService CustomerService
@inject IScreeningService ScreeningService
@inject NavigationManager Nav
@inject JwtHttpClientHandler JwtHandler


<h3>Min Side</h3>

@if (loading)
{
    <p>Henter data...</p>
}
else if (customer is null)
{
    <div class="alert alert-danger">Henter kunde data, vent et øjeblik.</div>
}
else
{
    <!-- Kundedata -->
    <div class="card mb-4">
        <div class="card-header">Mine oplysninger</div>
        <div class="card-body">
            <p><strong>Navn:</strong> @customer.Name</p>
            <p><strong>Telefon:</strong> @customer.Phone</p>
            <p><strong>Email:</strong> @customer.Email</p>
        </div>
    </div>

    <!-- Kommende bookinger -->
    <div class="card mb-4">
        <div class="card-header">Kommende bookinger</div>
        <div class="card-body">
            @if (!upcoming.Any())
            {
                <p>Ingen kommende bookinger.</p>
            }
            else
            {
                foreach (var b in upcoming)
                {
                    <div class="border rounded p-3 mb-3">
                        <h5>@b.MovieTitle</h5>
                        <p>
                            Dag @b.Date<br />
                            Tidspunkt @b.Time<br />
                            Bestilte sæder @string.Join(", ", b.Seats)
                        </p>

                        <button class="btn btn-primary me-2" @onclick="@(() => EditBooking(b))">Redigér</button>
                        <button class="btn btn-danger" @onclick="@(() => AskDelete(b))">Slet</button>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Tidligere bookinger -->
    <div class="card mb-4">
        <div class="card-header">Tidligere bookinger</div>
        <div class="card-body">
            @if (!previous.Any())
            {
                <p>Ingen tidligere bookinger.</p>
            }
            else
            {
                foreach (var b in previous)
                {
                    <div class="border rounded p-3 mb-3">
                        <h5>@b.MovieTitle</h5>
                        <p>
                            Dato @b.Date<br />
                            Bestilte sæder @string.Join(", ", b.Seats)
                        </p>
                    </div>
                }
            }
        </div>
    </div>
}

@if (showDeletePopup)
{
    <div class="modal-backdrop fade show"></div>
    <div class="modal fade show d-block">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Bekræft sletning</h5>
                </div>
                <div class="modal-body">
                    Vil du slette denne booking?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Annuller</button>
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Slet</button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private CustomerDto? customer;
    private List<CustomerBookingDto> bookings = new();
    private List<CustomerBookingDto> upcoming = new();
    private List<CustomerBookingDto> previous = new();
   

    private bool loading = true;
    private bool showDeletePopup = false;
    private CustomerBookingDto? bookingToDelete;
    
    /// <summary>
    /// initializes the component and subscribes to authentication state changes.
    /// </summary>

    protected override async Task OnInitializedAsync()
    {
        Auth.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await TryLoadDataAsync();
        
     
    }
    
    /// <summary>
    /// Async handler that reloads customer data when the authentication state changes.
    /// </summary>
    /// <param name="task"></param>

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await TryLoadDataAsync();
        StateHasChanged();
    }

   /// <summary>
   /// Tries to load customer data and bookings based on the authenticated user's phone number.
   /// </summary>

    private async Task TryLoadDataAsync()
    {
        loading = true;
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

       var phone = user.Claims.FirstOrDefault(c => c.Type == "phone")?.Value;

        if (string.IsNullOrEmpty(phone))
        {
            loading = false;
            return;
        }

        try
        {
            
            var customerTask = CustomerService.GetSingleCustomerAsync(phone);
            var bookingsTask = ScreeningService.GetBookingsByPhoneAsync(phone);

            await Task.WhenAll(customerTask, bookingsTask);

            customer = customerTask.Result;
            bookings = bookingsTask.Result;

            upcoming = bookings.Where(b => DateTime.Parse(b.Date) >= DateTime.Today).ToList();
            previous = bookings.Where(b => DateTime.Parse(b.Date) < DateTime.Today).ToList();
        }
        catch (Exception ex)
        {
            Console.WriteLine("Fejl i Customer: " + ex);
        }
        finally
        {
            loading = false;
        }
    }
    
    /// <summary>
    /// Edits a booking by navigating to the order page for the specified screening ID.
    /// </summary>
    /// <param name="booking"></param>

    private void EditBooking(CustomerBookingDto booking)
    {
        Nav.NavigateTo($"/order/{booking.ScreeningId}");
    }
    
    /// <summary>
    /// Asks for confirmation to delete a booking.
    /// </summary>
    /// <param name="booking"></param>

    private void AskDelete(CustomerBookingDto booking)
    {
        bookingToDelete = booking;
        showDeletePopup = true;
    }
    
    /// <summary>
    /// cancels the delete operation and hides the confirmation popup.
    /// </summary>

    private void CancelDelete()
    {
        bookingToDelete = null;
        showDeletePopup = false;
    }
    
    /// <summary>
    /// Confirms the deletion of a booking and updates the UI accordingly.
    /// </summary>

    private async Task ConfirmDelete()
    {
        
        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        var phone = user.Claims.FirstOrDefault(c => c.Type == "phone")?.Value;
        if (bookingToDelete is null)
            return;

        await ScreeningService.DeleteBookingSeatAsync(bookingToDelete.ScreeningId , phone );

        bookings.Remove(bookingToDelete);
        upcoming.Remove(bookingToDelete);

        bookingToDelete = null;
        showDeletePopup = false;
    }
    
    /// <summary>
    /// on after render lifecycle method to mark JS as ready
    /// </summary>
    /// <param name="firstRender"></param>
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            JwtHandler.MarkJsReady();
        }
    }

}
