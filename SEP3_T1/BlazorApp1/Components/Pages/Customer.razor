@page "/customer"
@using ApiContract
@using BlazorApp1.Services
@using Microsoft.AspNetCore.Components.Authorization

@inject AuthenticationStateProvider Auth
@inject ICustomerService CustomerService
@inject IScreeningService ScreeningService
@inject NavigationManager Nav

<h3>Min Side</h3>

@if (loading)
{
    <p>Henter data...</p>
}
else if (customer is null)
{
    <div class="alert alert-danger">
        Kunne ikke hente kundeoplysninger.
    </div>
}
else
{
    <!-- Kundedata -->
    <div class="card mb-4">
        <div class="card-header">Mine oplysninger</div>
        <div class="card-body">
            <p><strong>Navn:</strong> @customer.Name</p>
            <p><strong>Telefon:</strong> @customer.Phone</p>
            <p><strong>Email:</strong> @customer.Email</p>
        </div>
    </div>

    <!-- Kommende bookinger -->
    <div class="card mb-4">
        <div class="card-header">Kommende bookinger</div>
        <div class="card-body">
            @if (!upcoming.Any())
            {
                <p>Ingen kommende bookinger.</p>
            }
            else
            {
                foreach (var b in upcoming)
                {
                    <div class="border rounded p-3 mb-3">
                        <h5>@b.MovieTitle</h5>
                        <p>
                            📅 @b.Date<br />
                            🕒 @b.Time<br />
                            💺 @string.Join(", ", b.Seats)
                        </p>

                        <button class="btn btn-primary me-2" @onclick="@(() => EditBooking(b))">
                            Redigér
                        </button>

                        <button class="btn btn-danger" @onclick="@(() => AskDelete(b))">
                            Slet
                        </button>
                    </div>
                }
            }
        </div>
    </div>

    <!-- Tidligere bookinger -->
    <div class="card mb-4">
        <div class="card-header">Tidligere bookinger</div>
        <div class="card-body">
            @if (!previous.Any())
            {
                <p>Ingen tidligere bookinger.</p>
            }
            else
            {
                foreach (var b in previous)
                {
                    <div class="border rounded p-3 mb-3">
                        <h5>@b.MovieTitle</h5>
                        <p>
                            📅 @b.Date<br />
                            💺 @string.Join(", ", b.Seats)
                        </p>
                    </div>
                }
            }
        </div>
    </div>
}

@if (showDeletePopup)
{
    <div class="modal fade show d-block" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Bekræft sletning</h5>
                </div>
                <div class="modal-body">
                    Vil du slette denne booking?
                </div>
                <div class="modal-footer">
                    <button class="btn btn-secondary" @onclick="CancelDelete">Annuller</button>
                    <button class="btn btn-danger" @onclick="ConfirmDelete">Slet</button>
                </div>
            </div>
        </div>
    </div>
    <div class="modal-backdrop fade show"></div>
}

@code {
    private CustomerDto? customer;
    private List<CustomerBookingDto> bookings = new();
    private List<CustomerBookingDto> upcoming = new();
    private List<CustomerBookingDto> previous = new();

    private bool loading = true;
    private bool dataLoaded = false;   // sikrer vi kun loader én gang

    private bool showDeletePopup = false;
    private CustomerBookingDto? bookingToDelete;

    protected override async Task OnInitializedAsync()
    {
        Auth.AuthenticationStateChanged += OnAuthenticationStateChanged;
        await TryLoadDataAsync();
    }

    private async void OnAuthenticationStateChanged(Task<AuthenticationState> task)
    {
        await TryLoadDataAsync();
        StateHasChanged();
    }

    public void Dispose()
    {
        Auth.AuthenticationStateChanged -= OnAuthenticationStateChanged;
    }

    private async Task TryLoadDataAsync()
    {
        if (dataLoaded)
            return; // vi har allerede hentet data

        loading = true;

        var authState = await Auth.GetAuthenticationStateAsync();
        var user = authState.User;

        // prøv at finde phone-claim
        string? phone = user.Claims.FirstOrDefault(c => c.Type == "phone")?.Value;

        if (string.IsNullOrEmpty(phone))
        {
            // Token er ikke klar endnu – bare vent på AuthenticationStateChanged-eventet
            loading = false;
            return;
        }

        try
        {
            // Kundens info
            customer = await CustomerService.GetSingleCustomerAsync(phone);

            // Bookinger
            bookings = await ScreeningService.GetBookingsByPhoneAsync(phone);

            // Del op i kommende og tidligere
            upcoming = bookings
                .Where(b => DateTime.Parse(b.Date) >= DateTime.Today)
                .ToList();

            previous = bookings
                .Where(b => DateTime.Parse(b.Date) < DateTime.Today)
                .ToList();

            dataLoaded = true;
        }
        catch (Exception ex)
        {
            Console.WriteLine("Fejl i Customer-siden: " + ex);
        }
        finally
        {
            loading = false;
        }
    }

    private void EditBooking(CustomerBookingDto booking)
    {
        Nav.NavigateTo($"/edit-booking/{booking.ScreeningId}");
    }

    private void AskDelete(CustomerBookingDto booking)
    {
        bookingToDelete = booking;
        showDeletePopup = true;
    }

    private void CancelDelete()
    {
        bookingToDelete = null;
        showDeletePopup = false;
    }

    private async Task ConfirmDelete()
    {
        if (bookingToDelete is null)
            return;

        await ScreeningService.DeleteBookingAsync(bookingToDelete);

        bookings.Remove(bookingToDelete);
        upcoming.Remove(bookingToDelete);

        bookingToDelete = null;
        showDeletePopup = false;
    }
}

