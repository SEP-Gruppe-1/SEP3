@page "/NewScreening"
@using System.ComponentModel.DataAnnotations
@using ApiContract
@using BlazorApp1.Services
@using RepositoryContracts
@inject IScreeningService Service
@inject IMovieService MovieService
<h3>NyFilmvisning</h3>

<div class="card mb-4">
    <div class="card-header">Opret Filmvisning</div>
    <div class="card-body">
        @if (!string.IsNullOrWhiteSpace(errorMessage))
        {
            <div class="alert alert-danger mt-3" role="alert">@errorMessage</div>
        }
        <EditForm Model="newScreening" OnValidSubmit="SaveScreeningAsync" FormName="Lav ny filmvisning">
            <DataAnnotationsValidator/>

            <div class="mb-3">
                <label class="form-label">Film</label>

                <InputText class="form-control"
                           placeholder="Søg efter film..."
                           @bind-Value="movieSearch"
                           @oninput="OnMovieSearch" />

                @if (movieResults.Any())
                {
                    <ul class="list-group mt-2">
                        @foreach (var movie in movieResults)
                        {
                            <li class="list-group-item list-group-item-action"
                                @onclick="() => SelectMovie(movie)">
                                <strong>@movie.MovieTitle</strong>
                                (@movie.ReleaseDate) – @movie.Genre
                            </li>
                        }
                    </ul>
                }

                @if (selectedMovie != null)
                {
                    <div class="alert alert-success mt-2">
                        Valgt film: <strong>@selectedMovie.MovieTitle</strong>
                    </div>
                }
            </div>

            
            <div class="mb-3">
                <label class="form-label">HallId:</label>
                <InputText @bind-Value="newScreening.HallId" class="form-control"/>
                <ValidationMessage For="() => newScreening.HallId"/>
            </div>
            
            <div class="mb-3">
                <label class="form-label">StartTime:</label>
                <InputText type="time"
                           @bind-Value="newScreening.StartTime"
                           class="form-control" />
                <ValidationMessage For="() => newScreening.StartTime"/>
            </div>
            
            <div class="mb-3">
                <label class="form-label">Date:</label>
                <InputText type="date"
                           @bind-Value="newScreening.Date"
                           class="form-control" />
                <ValidationMessage For="() => newScreening.Date"/>
            </div>

            @if (showSuccessPopup)
            {
                <div class="modal fade show d-block" tabindex="-1">
                    <div class="modal-dialog modal-dialog-centered">
                        <div class="modal-content">
                            <div class="modal-header bg-success text-white">
                                <h5 class="modal-title">Filmvisning oprettet</h5>
                            </div>

                            <div class="modal-body">
                                <p>@successMessage</p>
                            </div>

                            <div class="modal-footer">
                                <button class="btn btn-success" @onclick="CloseSuccessPopup">
                                    OK
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-backdrop fade show"></div>
            }


         
            


            <button class="btn btn-success" type="submit" disabled="@isBusy" FormName="SignUpForm">Opret filmvisning</button>

        </EditForm>
    </div>
</div>


@code {
    
    private string movieSearch = "";
    private List<MovieDto> movieResults = new();
    private MovieDto? selectedMovie;
    private bool showSuccessPopup = false;
    private string successMessage = "";
    private createScreeningFromModel newScreening = new();
    private bool isBusy;
    private string? errorMessage;
    
    private class createScreeningFromModel
    {
       
        public string MovieId { get; set; }

      
        public string? HallId { get; set; }

      
        public string? StartTime { get; set; }

        public string? Date { get; set; }

    }
    
    private async Task SaveScreeningAsync()
    {
        
        if (selectedMovie == null)
        {
            errorMessage = "Du skal vælge en film";
            return;
        }
  
        isBusy = true;
        try
        {
            
            var normalizedTime = newScreening.StartTime!.Replace('.', ':');
            var screeningDto = new ScreeningCreateDto
            (
                MovieId: selectedMovie.MovieId,
                HallId: int.Parse( newScreening.HallId!),
                StartTime: normalizedTime,
                Date: newScreening.Date
            );

            await Service.CreateScreeningAsync(screeningDto);

            errorMessage = null;
            
            successMessage =
                $"Filmvisningen for '{selectedMovie.MovieTitle}'\n\n" +
                $"Dato: {newScreening.Date}\n" +
                $"Tid: {newScreening.StartTime}\n" +
                $"Sal: {newScreening.HallId}";

            showSuccessPopup = true;

          
        }
        catch (Exception ex)
        {
            errorMessage = ex.Message;
        }
        finally
        {
            isBusy = false;
        }
    }
    
    private async Task OnMovieSearch(ChangeEventArgs e)
    {
        movieSearch = e.Value?.ToString() ?? "";

        if (movieSearch.Length < 2)
        {
            movieResults.Clear();
            return;
        }

        movieResults = await MovieService.SearchMoviesAsync(movieSearch);
    }

    private void SelectMovie(MovieDto movie)
    {
        selectedMovie = movie;
        movieResults.Clear();
        errorMessage = null;
    }
    
    private void CloseSuccessPopup()
    {
        showSuccessPopup = false;
        errorMessage = null;

       
        newScreening = new();
        selectedMovie = null;
        movieSearch = "";
    }

    
    
}