@page "/MovieDetails/{movieId:int}"
@using ApiContract
@using Entities
@using RepositoryContracts
@inject IMovieService MovieService
@inject IScreeningRepository ScreeningRepo
@inject IMovieRepository MovieRepo
@inject NavigationManager Nav
@inject JwtHttpClientHandler JwtHandler


<h3>Filmdetaljer</h3>

@if (isLoading)
{
    <p><strong>Henter film...</strong></p>
}
else if (movie == null)
{
    <p>Film ikke fundet.</p>
}
else
{
    
    <div class="movie-banner">
        <img src="@GetBanner(movie)" alt="@movie.MovieTitle"/>
    </div>

    
    @if (groupedScreenings?.Any() == true)
    {
        <div class="screening-strip">
            <div class="screening-days">
                @foreach (var day in groupedScreenings)
                {
                    <div class="screening-day">
                        <div class="screening-day-header">
                            <div class="screening-day-label">@GetDayLabel(day.Key)</div>
                        </div>

                        <div class="screening-time">
                            @foreach (var s in day.Value)
                            {
                                <button class="btn btn-danger screening-time-btn"
                                        @onclick="@(() => GoToOrder(s.screeningId))">
                                    @s.startTime.ToString("HH':'mm")
                                </button>
                            }
                        </div>
                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <h4 class="no-screenings-text">Ingen kommende forestillinger</h4>
    }
}

@code {
    [Parameter] public int movieId { get; set; }

    private MovieDto? movie;
    private bool isLoading = true;

    private Dictionary<DateOnly, List<Screening>>? groupedScreenings;
    
    
    /// <summary>
    /// On component initialization, fetch movie details and screenings
    /// </summary>

    protected override async Task OnInitializedAsync()
    {
        isLoading = true;

        try
        {
            movie = await MovieService.GetMovieByIdAsync(movieId);
            if (movie == null) return;

            var screenings = await ScreeningRepo.getAll();
            var today = DateOnly.FromDateTime(DateTime.Today);

            groupedScreenings = screenings
                .Where(s => s.movie.MovieId == movieId && s.date >= today)
                .GroupBy(s => s.date)
                .OrderBy(g => g.Key)
                .ToDictionary(
                    g => g.Key,
                    g => g.OrderBy(s => s.startTime).ToList()
                );
        }
        finally
        {
            isLoading = false;
        }
    }
/// <summary>
/// gets the banner URL for the given movie.
/// </summary>
/// <param name="movie"></param>
/// <returns></returns>
    private string GetBanner(MovieDto movie)
    {
        return movie.banner_Url;
    }
    /// <summary>
    /// gets a label for the given date.
    /// </summary>
    /// <param name="date"></param>
    /// <returns></returns>

    private string GetDayLabel(DateOnly date)
    {
        var today = DateOnly.FromDateTime(DateTime.Today);

        if (date == today) return "I dag";
        if (date == today.AddDays(1)) return "I morgen";

        return date.ToString("ddd d/M");
    }
/// <summary>
/// goes to the order page for the given screening ID.
/// </summary>
/// <param name="screeningId"></param>
    private void GoToOrder(int screeningId)
    {
        Nav.NavigateTo($"/order/{screeningId}");
    }
    
    /// <summary>
    /// on after render lifecycle method to mark JS as ready
    /// </summary>
    /// <param name="firstRender"></param>
    
    protected override void OnAfterRender(bool firstRender)
    {
        if (firstRender)
        {
            JwtHandler.MarkJsReady();
        }
    }

}